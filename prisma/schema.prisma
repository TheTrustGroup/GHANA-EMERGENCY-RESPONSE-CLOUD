generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model agencies {
  id                   String                 @id
  name                 String
  type                 AgencyType
  description          String?
  contactEmail         String
  contactPhone         String
  address              String
  region               String
  district             String
  latitude             Float
  longitude            Float
  coverageRadius       Float                  @default(50)
  isActive             Boolean                @default(true)
  capacity             Int                    @default(10)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  dispatch_assignments dispatch_assignments[]
  incidents            incidents[]
  users                users[]

  @@index([isActive])
  @@index([latitude, longitude])
  @@index([region])
  @@index([type])
}

model audit_logs {
  id        String   @id
  userId    String
  action    String
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  users     users    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([entity, entityId])
  @@index([userId])
}

model dispatch_assignments {
  id               String         @id
  incidentId       String
  agencyId         String
  responderId      String
  status           DispatchStatus @default(DISPATCHED)
  priority         Int            @default(3)
  dispatchNotes    String?
  completionNotes  String?
  currentLatitude  Float?
  currentLongitude Float?
  createdAt        DateTime       @default(now())
  dispatchedAt     DateTime       @default(now())
  acceptedAt       DateTime?
  enRouteAt        DateTime?
  arrivedAt        DateTime?
  completedAt      DateTime?
  agencies         agencies       @relation(fields: [agencyId], references: [id])
  incidents        incidents      @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  users            users          @relation(fields: [responderId], references: [id])

  @@index([agencyId])
  @@index([incidentId])
  @@index([responderId])
  @@index([status])
}

model incident_updates {
  id         String     @id
  incidentId String
  userId     String
  updateType UpdateType
  content    String
  metadata   Json?
  createdAt  DateTime   @default(now())
  incidents  incidents  @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  users      users      @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([incidentId])
}

model incidents {
  id                      String                 @id
  category                IncidentCategory
  severity                IncidentSeverity
  status                  IncidentStatus         @default(REPORTED)
  title                   String
  description             String?
  latitude                Float
  longitude               Float
  address                 String?
  region                  String
  district                String
  mediaUrls               String[]
  reportedById            String?
  reporterPhone           String?
  reporterName            String?
  assignedAgencyId        String?
  priority                Int                    @default(3)
  estimatedAffectedPeople Int?
  responseTime            Int?
  resolutionTime          Int?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime
  dispatchedAt            DateTime?
  resolvedAt              DateTime?
  closedAt                DateTime?
  dispatch_assignments    dispatch_assignments[]
  incident_updates        incident_updates[]
  agencies                agencies?              @relation(fields: [assignedAgencyId], references: [id])
  users                   users?                 @relation(fields: [reportedById], references: [id])
  messages                messages[]

  @@index([assignedAgencyId])
  @@index([category])
  @@index([createdAt])
  @@index([latitude, longitude])
  @@index([region, district])
  @@index([severity])
  @@index([status])
}

model messages {
  id              String    @id
  incidentId      String
  senderId        String
  content         String
  isSystemMessage Boolean   @default(false)
  createdAt       DateTime  @default(now())
  incidents       incidents @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  users           users     @relation(fields: [senderId], references: [id])

  @@index([createdAt])
  @@index([incidentId])
  @@index([senderId])
}

model notifications {
  id                String           @id
  userId            String
  title             String
  message           String
  type              NotificationType
  relatedEntityType String?
  relatedEntityId   String?
  isRead            Boolean          @default(false)
  sentViaSms        Boolean          @default(false)
  sentViaPush       Boolean          @default(false)
  createdAt         DateTime         @default(now())
  readAt            DateTime?
  users             users            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isRead])
  @@index([userId])
}

model users {
  id                   String                 @id
  email                String                 @unique
  phone                String?                @unique
  name                 String
  passwordHash         String
  role                 UserRole
  agencyId             String?
  isActive             Boolean                @default(true)
  emailVerified        DateTime?
  phoneVerified        DateTime?
  lastLatitude         Float?
  lastLongitude        Float?
  lastLocationUpdate   DateTime?
  status               UserStatus             @default(AVAILABLE)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  lastLoginAt          DateTime?
  audit_logs           audit_logs[]
  dispatch_assignments dispatch_assignments[]
  incident_updates     incident_updates[]
  incidents            incidents[]
  messages             messages[]
  notifications        notifications[]
  agencies             agencies?              @relation(fields: [agencyId], references: [id])

  @@index([agencyId])
  @@index([email])
  @@index([isActive])
  @@index([phone])
  @@index([role])
  @@index([status])
}

enum AgencyType {
  NADMO
  FIRE_SERVICE
  POLICE
  AMBULANCE
  PRIVATE_RESPONDER
}

enum DispatchStatus {
  DISPATCHED
  ACCEPTED
  EN_ROUTE
  ARRIVED
  COMPLETED
  CANCELLED
}

enum IncidentCategory {
  FIRE
  MEDICAL
  ACCIDENT
  NATURAL_DISASTER
  CRIME
  INFRASTRUCTURE
  OTHER
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  REPORTED
  DISPATCHED
  IN_PROGRESS
  RESOLVED
  CLOSED
  CANCELLED
}

enum NotificationType {
  INCIDENT_CREATED
  INCIDENT_ASSIGNED
  DISPATCH_ASSIGNMENT
  STATUS_UPDATE
  MESSAGE_RECEIVED
  SYSTEM_ALERT
}

enum UpdateType {
  STATUS_CHANGE
  ASSIGNMENT
  RESPONDER_UPDATE
  MEDIA_ADDED
  NOTE_ADDED
  SYSTEM_UPDATE
}

enum UserRole {
  CITIZEN
  RESPONDER
  DISPATCHER
  AGENCY_ADMIN
  SYSTEM_ADMIN
}

enum UserStatus {
  AVAILABLE
  DISPATCHED
  EN_ROUTE
  ON_SCENE
  OFF_DUTY
}
